version: "3.9"
services:
  postgres:
    image: postgres:15.3-alpine3.18
    restart: always
    environment:
      POSTGRES_PASSWORD: useless
    ports:
      - "5432:5432"
  app:
    image: ghcr.io/and-mora/expenses-monitor:${tag}
    restart: always
    ports:
      - "8443:8443"
    depends_on:
      - postgres
    environment:
      DB_CONNECTION_URI: "r2dbc:postgresql://postgres/postgres"
      DB_SCHEMA: expenses
    volumes:
      - /etc/letsencrypt/live/expmonitor.freeddns.org/privkey.pem:/key.pem
      - /etc/letsencrypt/live/expmonitor.freeddns.org/fullchain.pem:/cert.pem
    secrets:
      - BASIC_AUTH_USERNAME
      - BASIC_AUTH_PASSWORD
      - DB_BACKEND_USER
      - DB_BACKEND_PASSWORD

secrets:
  BASIC_AUTH_USERNAME:
    external: true
  BASIC_AUTH_PASSWORD:
    external: true
  DB_BACKEND_USER:
    external: true
  DB_BACKEND_PASSWORD:
    external: true
#  POSTGRES_PASSWORD:
#    external: true
