âˆšopenapi: 3.0.3
info:
  title: Expenses Monitor API
  description: |
    REST API for personal expense tracking and financial management.
    
    **Authentication:** All endpoints (except `/greet` and `/health_check`) require Bearer token authentication via Keycloak OAuth2.
    
    **Base URL:** Configurable via environment variable (e.g., `https://api.expenses-monitor.com`)
  version: 1.0.0
  contact:
    name: Andrea Morabito
    email: andrea.morabito@example.com
  license:
    name: MIT

servers:
  - url: https://api.expmonitor.freeddns.org
    description: Production server
  - url: http://localhost:8080
    description: Local development server

tags:
  - name: Health
    description: Health check and system status endpoints
  - name: Balance
    description: Financial balance operations
  - name: Payments
    description: Payment/transaction management
  - name: Wallets
    description: Wallet management operations

security:
  - bearerAuth: []

paths:
  /health_check:
    get:
      tags:
        - Health
      summary: Health check endpoint
      description: Check if the API is running and responsive
      operationId: healthCheck
      security: []
      responses:
        '200':
          description: Service is healthy
          content:
            text/plain:
              schema:
                type: string
                example: OK

  /greet:
    get:
      tags:
        - Health
      summary: Simple greeting endpoint
      description: Test endpoint that returns a greeting message
      operationId: greet
      security: []
      responses:
        '200':
          description: Greeting message
          content:
            text/plain:
              schema:
                type: string
                example: Hello from backend

  /api/balance:
    get:
      tags:
        - Balance
      summary: Get current balance
      description: Returns the total balance calculated as the sum of all payment amounts
      operationId: getBalance
      responses:
        '200':
          description: Current balance retrieved successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Balance'
        '401':
          $ref: '#/components/responses/UnauthorizedError'
        '500':
          $ref: '#/components/responses/InternalServerError'

  /api/payments:
    get:
      tags:
        - Payments
      summary: Get payments
      description: Retrieve a paginated list of payments, ordered by accounting date (most recent first)
      operationId: getPayments
      parameters:
        - name: page
          in: query
          description: Page number (0-indexed)
          required: false
          schema:
            type: integer
            default: 0
            minimum: 0
        - name: size
          in: query
          description: Number of payments per page
          required: false
          schema:
            type: integer
            default: 50
            minimum: 1
            maximum: 1000
      responses:
        '200':
          description: Paginated list of payments
          content:
            application/json:
              schema:
                type: object
                properties:
                  content:
                    type: array
                    items:
                      $ref: '#/components/schemas/Payment'
                  page:
                    type: integer
                    description: Current page number
                  size:
                    type: integer
                    description: Page size
        '401':
          $ref: '#/components/responses/UnauthorizedError'
        '500':
          $ref: '#/components/responses/InternalServerError'
    
    post:
      tags:
        - Payments
      summary: Create a new payment
      description: Record a new financial transaction (expense or income)
      operationId: createPayment
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/PaymentCreate'
      responses:
        '201':
          description: Payment created successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Payment'
        '400':
          $ref: '#/components/responses/BadRequestError'
        '401':
          $ref: '#/components/responses/UnauthorizedError'
        '422':
          $ref: '#/components/responses/ValidationError'
        '500':
          $ref: '#/components/responses/InternalServerError'

  /api/payments/{paymentId}:
    put:
      tags:
        - Payments
      summary: Update a payment
      description: |
        Update an existing payment by its ID. All fields must be provided (full replacement).
        
        **Features:**
        - Replace all payment fields (merchant, amount, category, date, description, wallet)
        - Replace tags: existing tags are removed and new ones are inserted
        - Amount sign change: converts expenses to income or vice versa
        - Wallet reassignment: change the wallet associated with the payment
        
        **Validation:**
        - Merchant name required (1-255 chars)
        - Amount in cents cannot be zero
        - Category required (1-100 chars)
        - Accounting date required (ISO 8601 format)
        - Wallet name must exist in the database
      operationId: updatePayment
      parameters:
        - name: paymentId
          in: path
          description: UUID of the payment to update
          required: true
          schema:
            type: string
            format: uuid
            example: 550e8400-e29b-41d4-a716-446655440000
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/PaymentUpdate'
      responses:
        '200':
          description: Payment updated successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Payment'
        '400':
          $ref: '#/components/responses/BadRequestError'
        '401':
          $ref: '#/components/responses/UnauthorizedError'
        '404':
          description: Payment or wallet not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
              examples:
                paymentNotFound:
                  summary: Payment not found
                  value:
                    code: "404"
                    detail: "Payment not found"
                walletNotFound:
                  summary: Wallet not found
                  value:
                    code: "400"
                    detail: "Wallet not found"
        '422':
          $ref: '#/components/responses/ValidationError'
        '500':
          $ref: '#/components/responses/InternalServerError'
    
    delete:
      tags:
        - Payments
      summary: Delete a payment
      description: Remove a payment by its ID
      operationId: deletePayment
      parameters:
        - name: paymentId
          in: path
          description: UUID of the payment to delete
          required: true
          schema:
            type: string
            format: uuid
            example: 550e8400-e29b-41d4-a716-446655440000
      responses:
        '204':
          description: Payment deleted successfully
        '401':
          $ref: '#/components/responses/UnauthorizedError'
        '404':
          description: Payment not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '500':
          $ref: '#/components/responses/InternalServerError'

  /api/payments/categories:
    get:
      tags:
        - Payments
      summary: Get all payment categories
      description: |
        Retrieve the list of all unique payment categories.
        
        **Note:** This endpoint can return either:
        - Server-Sent Events (SSE) stream (`text/event-stream`) - recommended
        - Plain text comma-separated list (`text/plain`)
      operationId: getCategories
      parameters:
        - name: type
          in: query
          description: |
            Filter categories by type:
            - `expense`: Returns all categories except 'income'
            - `income`: Returns only the 'income' category
            - If omitted, returns all categories
          required: false
          schema:
            type: string
            enum:
              - expense
              - income
          example: expense
      responses:
        '200':
          description: List of categories
          content:
            text/event-stream:
              schema:
                type: string
                description: SSE stream where each event contains one category name
                example: |
                  data: Groceries
                  
                  data: Transportation
                  
                  data: Entertainment
            text/plain:
              schema:
                type: string
                description: Comma-separated list of category names
                example: Groceries,Transportation,Entertainment,Dining,Healthcare
        '401':
          $ref: '#/components/responses/UnauthorizedError'
        '500':
          $ref: '#/components/responses/InternalServerError'

  /api/wallets:
    get:
      tags:
        - Wallets
      summary: Get all wallets
      description: Retrieve the list of all user wallets
      operationId: getWallets
      responses:
        '200':
          description: List of wallets
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/Wallet'
        '401':
          $ref: '#/components/responses/UnauthorizedError'
        '500':
          $ref: '#/components/responses/InternalServerError'

    post:
      tags:
        - Wallets
      summary: Create a new wallet
      description: Create a new wallet with a unique name
      operationId: createWallet
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/WalletCreate'
      responses:
        '201':
          description: Wallet created successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Wallet'
        '400':
          $ref: '#/components/responses/BadRequestError'
        '401':
          $ref: '#/components/responses/UnauthorizedError'
        '409':
          description: Wallet name already exists (unique constraint violation)
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
              example:
                code: "23505"
                detail: "Wallet with this name already exists"
        '500':
          $ref: '#/components/responses/InternalServerError'

  /api/wallets/{walletId}:
    delete:
      tags:
        - Wallets
      summary: Delete a wallet
      description: |
        Remove a wallet by its ID.
        
        **Note:** Cannot delete a wallet that has associated payments (foreign key constraint).
      operationId: deleteWallet
      parameters:
        - name: walletId
          in: path
          description: UUID of the wallet to delete
          required: true
          schema:
            type: string
            format: uuid
            example: 550e8400-e29b-41d4-a716-446655440000
      responses:
        '204':
          description: Wallet deleted successfully
        '401':
          $ref: '#/components/responses/UnauthorizedError'
        '404':
          description: Wallet not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '409':
          description: Cannot delete wallet with existing payments (foreign key violation)
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
              example:
                code: "23503"
                detail: "Cannot delete wallet: it contains payments"
        '500':
          $ref: '#/components/responses/InternalServerError'

components:
  securitySchemes:
    bearerAuth:
      type: http
      scheme: bearer
      bearerFormat: JWT
      description: |
        OAuth2 Bearer token from Keycloak.
        
        Include the token in the Authorization header:
        ```
        Authorization: Bearer <your-token>
        ```

  schemas:
    Balance:
      type: object
      required:
        - totalInCents
      properties:
        totalInCents:
          type: integer
          format: int32
          description: Total balance in cents (sum of all payment amounts)
          example: 125000
      example:
        totalInCents: 125000

    Payment:
      type: object
      required:
        - id
        - merchantName
        - amountInCents
        - category
        - accountingDate
        - wallet
      properties:
        id:
          type: string
          format: uuid
          description: Unique identifier for the payment
          example: 550e8400-e29b-41d4-a716-446655440000
        merchantName:
          type: string
          description: Name of the merchant or payee
          minLength: 1
          maxLength: 255
          example: Amazon
        amountInCents:
          type: integer
          format: int32
          description: |
            Payment amount in cents.
            - Positive values represent income
            - Negative values represent expenses
          example: -5499
        category:
          type: string
          description: Payment category
          minLength: 1
          maxLength: 100
          example: Shopping
        accountingDate:
          type: string
          format: date-time
          description: Date and time when the transaction occurred (ISO 8601 format)
          example: "2026-01-22T10:30:00"
        description:
          type: string
          description: Optional notes or description
          maxLength: 1000
          nullable: true
          example: Monthly subscription
        wallet:
          type: string
          description: Name of the wallet this payment belongs to
          example: Credit Card
        tags:
          type: array
          description: Optional key-value metadata tags
          items:
            $ref: '#/components/schemas/Tag'
          nullable: true

    PaymentCreate:
      type: object
      required:
        - merchantName
        - amountInCents
        - category
        - accountingDate
        - wallet
      properties:
        merchantName:
          type: string
          description: Name of the merchant or payee
          minLength: 1
          maxLength: 255
          example: Amazon
        amountInCents:
          type: integer
          format: int32
          description: |
            Payment amount in cents.
            - Positive values represent income
            - Negative values represent expenses
          example: -5499
        category:
          type: string
          description: Payment category
          minLength: 1
          maxLength: 100
          example: Shopping
        accountingDate:
          type: string
          format: date-time
          description: Date and time when the transaction occurred (ISO 8601 format)
          example: "2026-01-22T10:30:00"
        description:
          type: string
          description: Optional notes or description
          maxLength: 1000
          example: Monthly subscription
        wallet:
          type: string
          description: Name of the wallet this payment belongs to
          example: Credit Card
        tags:
          type: array
          description: Optional key-value metadata tags
          items:
            $ref: '#/components/schemas/Tag'

    PaymentUpdate:
      type: object
      required:
        - merchantName
        - amountInCents
        - category
        - accountingDate
        - wallet
      properties:
        merchantName:
          type: string
          description: Name of the merchant or payee
          minLength: 1
          maxLength: 255
          example: Amazon
        amountInCents:
          type: integer
          format: int32
          description: |
            Payment amount in cents.
            - Positive values represent income
            - Negative values represent expenses
            - Cannot be zero
          example: -5499
        category:
          type: string
          description: Payment category
          minLength: 1
          maxLength: 100
          example: Shopping
        accountingDate:
          type: string
          format: date-time
          description: Date and time when the transaction occurred (ISO 8601 format)
          example: "2026-01-22T10:30:00"
        description:
          type: string
          description: Optional notes or description
          maxLength: 1000
          example: Monthly subscription
        wallet:
          type: string
          description: Name of the wallet this payment belongs to (must exist in database)
          example: Credit Card
        tags:
          type: array
          description: Optional key-value metadata tags (replaces existing tags)
          items:
            $ref: '#/components/schemas/Tag'

    Wallet:
      type: object
      required:
        - id
        - name
      properties:
        id:
          type: string
          format: uuid
          description: Unique identifier for the wallet
          example: 550e8400-e29b-41d4-a716-446655440000
        name:
          type: string
          description: Unique name of the wallet
          minLength: 1
          maxLength: 100
          example: Credit Card

    WalletCreate:
      type: object
      required:
        - name
      properties:
        name:
          type: string
          description: Unique name of the wallet
          minLength: 1
          maxLength: 100
          example: PayPal

    Tag:
      type: object
      required:
        - key
        - value
      properties:
        key:
          type: string
          description: Tag key/name
          minLength: 1
          maxLength: 50
          example: project
        value:
          type: string
          description: Tag value
          minLength: 1
          maxLength: 255
          example: vacation-2026

    Error:
      type: object
      required:
        - code
        - detail
      properties:
        code:
          type: string
          description: Error code (often PostgreSQL error codes like 23505, 23503)
          example: "23505"
        detail:
          type: string
          description: Human-readable error message
          example: Wallet with this name already exists

  responses:
    UnauthorizedError:
      description: Authentication required or invalid token
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/Error'
          example:
            code: "401"
            detail: "Unauthorized: Invalid or missing authentication token"

    BadRequestError:
      description: Invalid request format or parameters
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/Error'
          example:
            code: "400"
            detail: "Invalid request body"

    ValidationError:
      description: Request validation failed
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/Error'
          example:
            code: "422"
            detail: "Validation error: merchantName is required"

    InternalServerError:
      description: Internal server error
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/Error'
          example:
            code: "500"
            detail: "Internal server error"

  examples:
    ExpensePayment:
      summary: Expense payment example
      value:
        merchantName: "Supermarket"
        amountInCents: -3250
        category: "Groceries"
        accountingDate: "2026-01-22"
        description: "Weekly grocery shopping"
        wallet: "Credit Card"
        tags:
          - key: "store"
            value: "Whole Foods"
          - key: "reimbursable"
            value: "false"

    IncomePayment:
      summary: Income payment example
      value:
        merchantName: "Employer Corp"
        amountInCents: 250000
        category: "Salary"
        accountingDate: "2026-01-15"
        description: "Monthly salary"
        wallet: "Bank Account"
        tags: []

    WalletExample:
      summary: Wallet example
      value:
        id: "550e8400-e29b-41d4-a716-446655440000"
        name: "Cash"
