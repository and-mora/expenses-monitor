name: Deploy on Manifest Change

on:
  push:
    branches: [ master ]
    paths:
      - 'manifest/backend/**'
      - 'manifest/backend-rust/**'
      - 'manifest/frontend/**'
      - 'manifest/frontend-companion/**'

jobs:
  DetectChanges:
    name: Detect Changed Manifests
    runs-on: ubuntu-latest
    outputs:
      backend_changed: ${{ steps.filter.outputs.backend }}
      backend_rust_changed: ${{ steps.filter.outputs.backend-rust }}
      frontend_changed: ${{ steps.filter.outputs.frontend }}
      frontend_companion_changed: ${{ steps.filter.outputs.frontend-companion }}
    steps:
      - uses: actions/checkout@v4
      
      - uses: dorny/paths-filter@v3
        id: filter
        with:
          filters: |
            backend:
              - 'manifest/backend/**'
            backend-rust:
              - 'manifest/backend-rust/**'
            frontend:
              - 'manifest/frontend/**'
            frontend-companion:
              - 'manifest/frontend-companion/**'

  BackendDeploy:
    needs: DetectChanges
    if: needs.DetectChanges.outputs.backend_changed == 'true'
    uses: ./.github/workflows/deploy_backend_argocd.yml
    secrets: inherit

  BackendApiTest:
    needs: BackendDeploy
    uses: ./.github/workflows/api_test.yml
    secrets: inherit

  BackendRustDeploy:
    needs: DetectChanges
    if: needs.DetectChanges.outputs.backend_rust_changed == 'true'
    uses: ./.github/workflows/deploy_backend_rust_argocd.yml
    secrets: inherit

  FrontendDeploy:
    needs: DetectChanges
    if: needs.DetectChanges.outputs.frontend_changed == 'true'
    uses: ./.github/workflows/deploy_frontend.yml
    with:
      version: 'latest'  # La versione è già nel manifest
      enabled: 'true'
    secrets: inherit

  FrontendCompanionDeploy:
    needs: DetectChanges
    if: needs.DetectChanges.outputs.frontend_companion_changed == 'true'
    # TODO: creare workflow deploy_frontend_companion.yml o migrare a ArgoCD
    runs-on: ubuntu-latest
    steps:
      - name: Placeholder for Frontend Companion Deploy
        run: echo "Frontend Companion deploy not yet implemented"
